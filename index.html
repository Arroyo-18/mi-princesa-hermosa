<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Mi Princesa Hermosa</title>
<link rel="icon" type="image/svg+xml" href="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'><path fill='#ffd700' d='M256,222.1c-18.7,0-33.9,15.2-33.9,33.9s15.2,33.9,33.9,33.9s33.9-15.2,33.9-33.9S274.7,222.1,256,222.1z'/><path fill='#ffd700' d='M237.4,196l37.3-123.4c1.2-4.7,1.9-9.6,1.9-14.7c0-32-25.9-57.9-57.9-57.9c-32,0-57.9,25.9-57.9,57.9c0,5.1,0.7,10,1.9,14.7L237.4,196z'/><path fill='#ffd700' d='M274.7,315.9l-37.4,123.4c-1.2,4.7-1.9,9.6-1.9,14.7c0,32,25.9,57.9,57.9,57.9s57.9-25.9,57.9-57.9c0-5.1-0.7-10-1.9-14.7L274.7,315.9z'/><path fill='#ffd700' d='M86.7,165.9l113.7,60.9c7.4,4.5,17.2,3.6,23.6-2.8c6.4-6.4,7.3-16.2,2.8-23.6L165.9,86.7c-2.5-4.2-5.5-8.2-9.1-11.8c-22.6-22.6-59.3-22.6-81.9,0c-22.6,22.6-22.6,59.3,0,81.9C82.5,160.5,86.5,163.5,86.7,165.9z'/><path fill='#ffd700' d='M425.3,346.1l-113.7-60.9c-7.4-4.5-17.2-3.6-23.5,2.8c-6.4,6.4-7.3,16.2-2.8,23.6l60.9,113.7c2.5,4.2,5.5,8.2,9.1,11.8c22.6,22.6,59.3,22.6,81.9,0c22.6-22.6,22.6-59.3,0-81.9C433.4,351.5,429.5,348.5,425.3,346.1z'/><path fill='#ffd700' d='M196,274.7c8.4-2.1,14.6-9.6,14.6-18.7c0-9-6.2-16.6-14.6-18.7L72.6,200c-4.7-1.2-9.6-1.9-14.7-1.9c-32,0-57.9,25.9-57.9,57.9s25.9,57.9,57.9,57.9c5.1,0,10-0.7,14.7-1.9L196,274.7z'/><path fill='#ffd700' d='M454.1,198.1c-5.1,0-10,0.7-14.7,1.9l-123.4,37.3c-8.4,2.1-14.6,9.6-14.6,18.7c0,9,6.2,16.6,14.6,18.7l123.4,37.3c4.7,1.2,9.6,1.9,14.7,1.9c32,0,57.9-25.9,57.9-57.9S486.1,198.1,454.1,198.1z'/><path fill='#ffd700' d='M224,288c-6.4-6.4-16.1-7.3-23.6-2.8L86.7,346.1c-4.2,2.5-8.2,5.5-11.8,9.1c-22.6,22.6-22.6,59.3,0,81.9c22.6,22.6,59.3,22.6,81.9,0c3.6-3.6,6.6-7.6,9.1-11.8l60.9-113.7C231.3,304.2,230.3,294.4,224,288z'/><path fill='#ffd700' d='M288,224c6.4,6.4,16.1,7.3,23.5,2.8l113.7-60.9c4.2-2.5,8.2-5.5,11.8-9.1c22.6-22.6,22.6-59.3,0-81.9c-22.6-22.6-59.3-22.6-81.9,0c-3.6,3.6-6.6,7.6-9.1,11.8l-60.9,113.7C280.7,207.8,281.7,217.6,288,224z'/></svg>">

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Allura&family=Dancing+Script&family=Great+Vibes&family=Parisienne&family=Azeret+Mono&display=swap" rel="stylesheet">

<style>
  :root{
    --bg-light: #f4f4f4;
    --bg-dark:  #111217;
    --text-light: #111;
    --text-dark: #f4f4f4;
    --muted: rgba(128,128,128,0.18);
    --vh: 1vh; /* actualizado por JS */
  }

  html,body{height:100%; margin:0; padding:0; -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;}
  body{
    font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Azeret Mono", monospace;
    transition: background-color .45s ease, color .45s ease;
    overflow:hidden;
    background: var(--bg-light);
    color: var(--text-light);
  }

  /* Stage usa --vh para evitar problemas con toolbars móviles */
  .stage{
    position: relative;
    width: 100vw;
    height: calc(var(--vh, 1vh) * 100);
    display:flex;
    align-items:center;
    justify-content:center;
  }

  canvas {
    display:block;
    cursor:pointer;
    z-index:1;
    box-shadow: 0 8px 30px rgba(0,0,0,0.12);
    border-radius: 18px;
    background: transparent;
  }

  #controls{
    position:absolute; top:12px; right:12px; z-index:12;
    display:flex; gap:12px; align-items:center;
  }
  .btn{
    background: var(--muted);
    border-radius:50%;
    width:48px; height:48px; display:flex; align-items:center;
    justify-content:center; font-size:22px; cursor:pointer; user-select:none;
    box-shadow: 0 4px 10px rgba(0,0,0,0.06);
    border: none;
  }
  .btn svg{ width:26px; height:auto; display:block; }

  #time{
    position:absolute; top:18px; left:0; right:0; text-align:center;
    z-index:11; font-family:'Azeret Mono', monospace; font-size:48px; user-select:none; cursor:pointer;
    text-shadow: 0 2px 6px rgba(0,0,0,0.08);
  }

  #secondBarContainer{ position:absolute; top:86px; left:0; right:0; display:flex; justify-content:center; z-index:11; }
  #secondBar{ display:flex; gap:2px; height:8px; align-items:center; }
  .segment{ width:6px; height:100%; background:#ccc; border-radius:2px; transition:background .3s; }

  /* phrase posicionada dinámicamente por JS */
  #phrase{
    position:absolute;
    left:5%;
    right:5%;
    z-index:11;
    font-size:34px;
    font-family:'Dancing Script', cursive;
    text-align:center;
    pointer-events:none;
    transition: transform .18s ease, top .18s ease, left .18s ease;
    padding-bottom: env(safe-area-inset-bottom);
  }

  @media (max-width:700px) {
    #time{ font-size:36px; top:12px; }
    #phrase{ font-size:24px; }
    .btn{ width:44px; height:44px; font-size:20px; }
    .segment{ width:4px; }
  }
  @media (orientation: landscape) and (max-height:500px){
    #time{ top:8px; font-size:30px; }
    #secondBarContainer{ top:54px; }
    #phrase{ font-size:20px; }
  }

  .dark{
    background: var(--bg-dark);
    color: var(--text-dark);
  }

  .btn:focus { outline: 2px solid rgba(255,255,255,0.12); outline-offset:2px; }
  #time:focus { outline: 2px dashed rgba(255,255,255,0.12); outline-offset:4px; border-radius:6px; }
</style>
</head>
<body>
  <div class="stage" id="stage">
    <div id="controls" role="group" aria-label="Controles">
      <button class="btn" id="modeBtn" aria-pressed="false" title="Cambiar modo (angel/devil)">👼</button>
      <button class="btn" id="countryBtn" title="Cambiar país (PE/IT)"></button>
    </div>

    <div id="time" tabindex="0" title="Toca para alternar tema (claro/oscuro)"></div>
    <div id="secondBarContainer"><div id="secondBar"></div></div>
    <div id="phrase" aria-live="polite"></div>

    <canvas id="flowerCanvas" role="img" aria-label="Flor animada"></canvas>
  </div>

<script>
/* ===========================
   Configuración y constantes
   =========================== */
const canvas = document.getElementById('flowerCanvas');
const ctx = canvas.getContext('2d', { alpha: true });
let cw = 0, ch = 0;
const dpr = Math.max(1, window.devicePixelRatio || 1);

const timeEl = document.getElementById('time');
const phraseEl = document.getElementById('phrase');
const modeBtn = document.getElementById('modeBtn');
const countryBtn = document.getElementById('countryBtn');

const ANGEL_ROTATION_SPEED = 0.02;
const DEVIL_SPEEDS = [0.03,0.06,0.10,0.15,0.20];
const PHRASE_TYPING_SPEED_MS = 45;
const PHRASE_FONTS = ['Dancing Script','Great Vibes','Parisienne','Allura'];

const flagSVGs = {
  PE: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 900 600"><rect width="900" height="600" fill="#D91023"/><rect x="300" width="300" height="600" fill="#FFF"/></svg>`,
  IT: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1500 1000"><rect width="500" height="1000" x="0" fill="#009246"/><rect width="500" height="1000" x="500" fill="#FFF"/><rect width="500" height="1000" x="1000" fill="#CE2B37"/></svg>`
};

const flowerPresets = [
  {n:60,w:20,round:0,orientation:'out',len:120,color:'#FFD700'},
  {n:30,w:20,round:1,orientation:'out',len:120,color:'#FFD700'},
  {n:16,w:25,round:0.5,orientation:'out',len:120,color:'#FFD700'},
  {n:8,w:50,round:1,orientation:'out',len:120,color:'#FFD700'},
  {n:7,w:70,round:1,orientation:'out',len:120,color:'#FFD700'},
  {n:5,w:80,round:1,orientation:'out',len:120,color:'#FFD700'},
  {n:4,w:100,round:1,orientation:'in',len:100,color:'#2ecc71'},
];
const devilStyle = {n:8,w:90,round:0.7,orientation:'out',len:120,color:'#D70040'};

const phrases = {
  angel:{
    PE:{morning:"Buenos días, mi princesa hermosa.",afternoon:"Buenas tardes, mi princesa hermosa.",night:"Buenas noches, mi princesa hermosa."},
    IT:{morning:"Buongiorno, mia principessa bellissima.",afternoon:"Buon pomeriggio, mia principessa bellissima.",night:"Buona notte, mia principessa bellissima."}
  },
  devil:{
    PE:{morning:"Buenos días, mi princesa sexy.",afternoon:"Buenas tardes, mi princesa sexy.",night:"Buenas noches, mi princesa sexy."},
    IT:{morning:"Buongiorno, mia principessa sexy.",afternoon:"Buon pomeriggio, mia principessa sexy.",night:"Buona notte, mia principessa sexy."}
  }
};

/* ===========================
   Estado
   =========================== */
let rotation = 0;
let rotationSpeed = ANGEL_ROTATION_SPEED;
let mode = 'angel';               // 'angel' | 'devil'
let country = 'PE';               // 'PE' | 'IT'
let flowerStyleIndex = 0;
let currentColor = '#FFD700';
let phraseIndex = 0;
let displayedPhrase = '';
let currentPhrase = '';
let currentFontIndex = 0;
let devilSpeedIndex = 0;
let speedDirection = 1;
let petalCounter = 1;
let forcedTheme = null;
let lastAutomaticTheme = null;

const segments = [];
const secondBar = document.getElementById('secondBar');
for(let i=0;i<60;i++){ const s = document.createElement('div'); s.className='segment'; secondBar.appendChild(s); segments.push(s); }

/* ===========================
   Helpers: tiempo y tema
   =========================== */
function getTimeOfDay(h){ if(h>=6 && h<12) return 'morning'; if(h>=12 && h<18) return 'afternoon'; return 'night'; }
function getTheme(h){ return (h>=6 && h<18) ? 'light' : 'dark'; }
function applyTheme(theme){
  if(theme==='dark') document.body.classList.add('dark'); else document.body.classList.remove('dark');
}
function contrastStrokeForBg(){
  const bg = getComputedStyle(document.body).backgroundColor || 'rgb(244,244,244)';
  const vals = bg.match(/\d+/g) || [244,244,244];
  const lum = (0.2126*vals[0] + 0.7152*vals[1] + 0.0722*vals[2]);
  return lum > 150 ? '#111' : '#f4f4f4';
}

/* ===========================
   Reloj y frase
   =========================== */
function updateTime(){
  const now = new Date();
  let h,m,s;
  const options = { hour:'2-digit', minute:'2-digit', second:'2-digit', hour12:false };
  if(country === 'IT'){
    options.timeZone = 'Europe/Rome';
    const timeParts = new Intl.DateTimeFormat('en-GB', options).format(now).split(':');
    h = parseInt(timeParts[0]); m = parseInt(timeParts[1]); s = parseInt(timeParts[2]);
  } else {
    h = now.getHours(); m = now.getMinutes(); s = now.getSeconds();
  }

  petalCounter++;
  if(s === 0) petalCounter = 0;

  timeEl.textContent = `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`;

  const automaticTheme = getTheme(h);
  if(lastAutomaticTheme !== null && automaticTheme !== lastAutomaticTheme){
    forcedTheme = null;
  }
  const themeToApply = forcedTheme || automaticTheme;
  applyTheme(themeToApply);
  lastAutomaticTheme = automaticTheme;

  const tod = getTimeOfDay(h);
  const newPhrase = phrases[mode][country][tod];
  if(newPhrase !== currentPhrase){
    currentPhrase = newPhrase;
    resetPhraseAnimation();
  }

  for(let i=0;i<60;i++){
    segments[i].style.backgroundColor = i < s ? currentColor : '#ccc';
  }
}

/* ===========================
   Canvas sizing (responsive + retina + visualViewport)
   =========================== */
function resizeCanvas(){
  // visualViewport preferido (maneja toolbars móviles)
  const viewportHeight = (window.visualViewport && window.visualViewport.height) ? window.visualViewport.height : window.innerHeight;
  const viewportWidth = (window.visualViewport && window.visualViewport.width) ? window.visualViewport.width : window.innerWidth;
  document.documentElement.style.setProperty('--vh', `${viewportHeight * 0.01}px`);

  // Margenes adaptativos para dejar espacio para la frase y toolbars
  const margin = Math.min(viewportWidth, viewportHeight) * 0.06;
  const marginV = Math.max(80, viewportHeight * 0.12);

  // tamano cuadrado del canvas
  const sizeCSS = Math.min(viewportWidth - margin, viewportHeight - marginV, Math.min(viewportWidth, viewportHeight) * 0.92);

  canvas.style.width = `${sizeCSS}px`;
  canvas.style.height = `${sizeCSS}px`;

  canvas.width = Math.round(sizeCSS * dpr);
  canvas.height = Math.round(sizeCSS * dpr);

  cw = sizeCSS;
  ch = sizeCSS;

  // trabaja en coordenadas CSS (no en device pixels)
  ctx.setTransform(dpr, 0, 0, dpr, 0, 0);

  positionPhrase();
  resetFlowerState();
}

/* ===========================
   Dibujo de la flor
   =========================== */
function drawPetal(angle, w, l, round, orientation, color){
  ctx.save();
  ctx.translate(cw/2, ch/2);
  const scale = cw / 500;
  ctx.scale(scale, scale);
  ctx.rotate(angle + rotation);
  ctx.beginPath();
  if(orientation === 'out'){
    ctx.moveTo(0,0);
    ctx.bezierCurveTo(w, -l*round, w*0.5, -l, 0, -l);
    ctx.bezierCurveTo(-w*0.5, -l, -w, -l*round, 0, 0);
  } else {
    ctx.moveTo(0,0);
    ctx.bezierCurveTo(w*0.4, -l*0.4, w, -l*round, 0, -l);
    ctx.bezierCurveTo(-w, -l*round, -w*0.4, -l*0.4, 0, 0);
  }
  ctx.closePath();
  ctx.fillStyle = color;
  ctx.fill();
  ctx.lineWidth = 2;
  ctx.strokeStyle = contrastStrokeForBg();
  ctx.stroke();
  ctx.restore();
}

function drawFlower(){
  ctx.clearRect(0, 0, canvas.width, canvas.height);

  const style = (mode === 'devil') ? devilStyle : flowerPresets[flowerStyleIndex];
  const petalCountForShape = style.n;
  const w = style.w;
  const l = style.len;
  const round = style.round;
  const orientation = style.orientation;
  currentColor = style.color;

  rotation += rotationSpeed;

  const maxPetals = petalCountForShape * 4;
  const drawCount = Math.min(Math.max(1, petalCounter), maxPetals);

  for(let i = 0; i < drawCount; i++){
    const angle = (Math.PI * 2 / petalCountForShape) * i;
    drawPetal(angle, w, l, round, orientation, currentColor);
  }
}

/* ===========================
   Frase tipo "typing" y posicionamiento
   =========================== */
function resetPhraseAnimation(){
  displayedPhrase = '';
  phraseIndex = 0;
  updatePhrase();
}

function updatePhrase(){
  if(phraseIndex < currentPhrase.length){
    displayedPhrase += currentPhrase[phraseIndex];
    phraseIndex++;
    phraseEl.textContent = getFlowerEmoji() + ' ' + displayedPhrase + ' ' + getFlowerEmoji();
    setTimeout(updatePhrase, PHRASE_TYPING_SPEED_MS);
  }
}

function getFlowerEmoji(){
  if(currentColor === '#D70040' || currentColor === '#e74c3c') return '🌹';
  if(currentColor === '#2ecc71') return '🍀';
  if(currentColor === '#3498db') return '💧';
  if(currentColor === '#9b59b6') return '💜';
  return '🌻';
}

/* ===========================
   Posicionar frase según espacio disponible
   =========================== */
function positionPhrase(){
  phraseEl.style.width = '';
  phraseEl.style.left = '5%';
  phraseEl.style.right = '5%';

  const vpWidth = (window.visualViewport && window.visualViewport.width) ? window.visualViewport.width : window.innerWidth;
  const vpHeight = (window.visualViewport && window.visualViewport.height) ? window.visualViewport.height : window.innerHeight;

  const canvasRect = canvas.getBoundingClientRect();
  // medir phrase con estilo aplicado (puede ser 0 si texto vacío; si es 0, estimamos)
  let phraseRect = phraseEl.getBoundingClientRect();
  if(phraseRect.height === 0){
    // forzar tamaño temporal para medir (estimación)
    phraseEl.style.visibility = 'hidden';
    phraseEl.textContent = (currentPhrase || '...') ;
    phraseRect = phraseEl.getBoundingClientRect();
    phraseEl.textContent = '';
    phraseEl.style.visibility = '';
  }

  const spaceBelow = vpHeight - canvasRect.bottom;
  const spaceAbove = canvasRect.top;
  const spaceRight = vpWidth - canvasRect.right;

  if (spaceBelow >= (phraseRect.height + 20)) {
    phraseEl.style.top = `${canvasRect.bottom + 10}px`;
    phraseEl.style.left = '5%';
    phraseEl.style.right = '5%';
    phraseEl.style.transform = 'translateY(0)';
  } else if (spaceRight >= (phraseRect.width + 20) && vpWidth > vpHeight) {
    phraseEl.style.top = `${canvasRect.top}px`;
    phraseEl.style.left = `${canvasRect.right + 10}px`;
    phraseEl.style.right = 'auto';
    phraseEl.style.width = `${Math.max(140, vpWidth - canvasRect.right - 20)}px`;
    phraseEl.style.transform = 'translateY(0)';
  } else if (spaceAbove >= (phraseRect.height + 20)) {
    phraseEl.style.top = `${Math.max(8, canvasRect.top - phraseRect.height - 10)}px`;
    phraseEl.style.left = '5%';
    phraseEl.style.right = '5%';
    phraseEl.style.transform = 'translateY(0)';
  } else {
    const centerTop = canvasRect.top + (canvasRect.height / 2) - (phraseRect.height / 2);
    phraseEl.style.top = `${Math.max(8, centerTop)}px`;
    phraseEl.style.left = '10%';
    phraseEl.style.right = '10%';
    phraseEl.style.transform = 'translateY(0)';
  }
}

/* ===========================
   Estado / interacciones
   =========================== */
function resetFlowerState(){
  petalCounter = 1;
  resetPhraseAnimation();
}

function animate(){
  drawFlower();
  requestAnimationFrame(animate);
}

/* ===========================
   Eventos de UI
   =========================== */
modeBtn.addEventListener('click', () => {
  mode = (mode === 'angel') ? 'devil' : 'angel';
  modeBtn.textContent = (mode === 'angel') ? '👼' : '😈';
  modeBtn.setAttribute('aria-pressed', mode === 'devil');
  rotationSpeed = (mode === 'devil') ? DEVIL_SPEEDS[devilSpeedIndex] : ANGEL_ROTATION_SPEED;
  resetFlowerState();
});

countryBtn.addEventListener('click', () => {
  country = (country === 'PE') ? 'IT' : 'PE';
  countryBtn.innerHTML = flagSVGs[country];
  resetFlowerState();
});

canvas.addEventListener('click', () => {
  if(mode === 'angel'){
    flowerStyleIndex = (flowerStyleIndex + 1) % flowerPresets.length;
    resetFlowerState();
  } else {
    devilSpeedIndex += speedDirection;
    if(devilSpeedIndex >= DEVIL_SPEEDS.length - 1 || devilSpeedIndex <= 0) speedDirection *= -1;
    rotationSpeed = DEVIL_SPEEDS[devilSpeedIndex];
  }
});

document.body.addEventListener('click', (e) => {
  if(e.target === canvas || e.target.closest('.btn') || e.target === timeEl) return;
  currentFontIndex = (currentFontIndex + 1) % PHRASE_FONTS.length;
  phraseEl.style.fontFamily = `'${PHRASE_FONTS[currentFontIndex]}', cursive`;
  resetPhraseAnimation();
});

timeEl.addEventListener('click', () => {
  const isDark = document.body.classList.contains('dark');
  forcedTheme = isDark ? 'light' : 'dark';
  applyTheme(forcedTheme);
});

timeEl.addEventListener('keydown', (ev) => {
  if(ev.key === 'Enter' || ev.key === ' '){
    ev.preventDefault();
    timeEl.click();
  }
});

window.addEventListener('resize', resizeCanvas);
window.addEventListener('orientationchange', () => { setTimeout(resizeCanvas, 120); });
window.addEventListener('load', () => { setTimeout(() => { resizeCanvas(); positionPhrase(); }, 60); });

if (window.visualViewport) {
  window.visualViewport.addEventListener('resize', () => { resizeCanvas(); });
  window.visualViewport.addEventListener('scroll', () => { positionPhrase(); });
}

/* ===========================
   Inicialización
   =========================== */
countryBtn.innerHTML = flagSVGs[country];

updateTime();
setInterval(updateTime, 1000);

resizeCanvas();
animate();
</script>
</body>
</html>

